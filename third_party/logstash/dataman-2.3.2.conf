input {
  tcp {
    port => 4999
  }
}

filter {
  ruby {
    code => "event['time'] = event.timestamp.time.localtime.strftime('%Y-%m-%d')"
  }
  json {
    source => "message"
  }
}

output {
  #stdout { codec => rubydebug }
  if "_jsonparsefailure" not in [tags] and [msg] =~ /^.+/ {
    if ([platform] == "app" or [platform] == "component") {
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        index => "dataman-%{platform}-%{clusterid}-%{time}"
        document_type => "dataman-%{typename}"
        template => "/etc/logstash/conf.d/logstash-2.1.0.json"
        template_name => "dataman"
        template_overwrite => "true"
      }
    }
  }
}
