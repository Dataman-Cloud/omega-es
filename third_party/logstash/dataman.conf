input {
  tcp {
    port => 4999
  }
}

filter {
  ruby {
    code => "event['time'] = event.timestamp.time.localtime.strftime('%Y-%m-%d')"
  }

  json {
    source => "message"
  }
}

output {
  #stdout { codec => rubydebug }
  if "_jsonparsefailure" not in [tags] and [msg] =~ /^.+/ {
    if ([platform] == "app" or [platform] == "component") {
      elasticsearch {
        host => ["elasticsearch"]
        port => "9200"
        protocol => "http"
        password => "dataman"
        index => "logstash-%{platform}-%{userid}-%{time}"
        document_type => "logstash-%{clusterid}-%{typename}"
        template => "/usr/local/logstash/conf/logstash.json"
        template_name => "logstash"
        template_overwrite => "true"
      }
    } else {
      elasticsearch {
        host => ["elasticsearch"]
        port => "9200"
        protocol => "http"
        password => "dataman"
        index => "logstash-%{userid}-%{time}"
        document_type => "logstash-%{clusterid}-%{typename}"
        template => "/usr/local/logstash/conf/logstash.json"
        template_name => "logstash"
        template_overwrite => "true"
      }
    }
  }
}

